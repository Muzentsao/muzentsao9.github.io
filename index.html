<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>木人艸 | 互動式報價系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fcfcfc; color: #333; }
        .pdf-container { background-color: #fff; border: 1.5px solid #000; padding: 25px; position: relative; }
        
        /* 核心表格設定：解決 PDF 下載後跑位與欄位擠壓 */
        .pdf-table { table-layout: fixed; width: 100%; border-collapse: collapse; }
        .pdf-table th, .pdf-table td { border: 1px solid #000; padding: 8px; font-size: 13px; vertical-align: middle; word-wrap: break-word; }
        
        /* 防止 PDF 跨頁時將表格列 (tr) 從中間切斷 */
        tr { page-break-inside: avoid; } 
        thead { display: table-header-group; }

        .header-bg { background-color: #fcf4d9; font-weight: bold; }
        .req::after { content: ' *'; color: #d93025; }
        .category-header { background-color: #f3f4f6; font-weight: bold; text-align: left; padding-left: 15px; border: 1px solid #000; font-size: 14px; color: #444; }
        .text-alert { color: #d93025; font-size: 11px; line-height: 1.5; font-weight: 500; }
        .no-border-input { border: none; width: 100%; background: transparent; outline: none; padding: 4px; }
        .no-border-input:focus { background-color: #fffef0; }
        .input-error { background-color: #fff0f0 !important; border: 1px inset #d93025 !important; }
        input[type="number"] { width: 55px; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
        
        @media print { .no-print { display: none !important; } .pdf-container { border: none; box-shadow: none; padding: 0; } }
        
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .img-preview { width: 48px; height: 48px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; cursor: zoom-in; transition: transform 0.2s; }
        .img-preview:hover { transform: scale(1.1); border-color: #556b2f; }
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-bottom: 2px; }
        .badge-vege { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .badge-meat { background-color: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
        .badge-gray { background-color: #f5f5f5; color: #757575; border: 1px solid #e0e0e0; }
        
        #lightbox { display: none; position: fixed; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        #lightbox img { max-width: 90%; max-height: 80%; border: 4px solid white; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* 按鈕載入動畫 */
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid #fff; width: 18px; height: 18px; animation: spin 0.8s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-10">

    <div id="lightbox" onclick="this.style.display='none'" class="no-print">
        <img id="lightbox-img" src="" alt="餐點大圖">
        <p class="absolute bottom-10 text-white text-sm font-light">點擊任何地方關閉預覽</p>
    </div>

    <div id="quotation-content" class="max-w-[1100px] mx-auto pdf-container shadow-2xl mb-10">
        <div class="flex justify-between items-start mb-6 border-b-2 border-black pb-4">
            <div class="text-sm">
                <h1 class="text-3xl font-bold tracking-tighter mb-1">木人艸</h1>
                <p>服務專線：02-2883-2113</p>
                <p>公司地址：台北市士林區後港街185號4樓</p>
            </div>
            <div class="text-center">
                <h2 class="text-xl font-bold tracking-widest uppercase">木人艸股份有限公司</h2>
                <p class="text-sm text-gray-600">台灣良農食材 (會議餐點 ‧ 餐盒 ‧ 蛋糕)</p>
            </div>
            <div class="text-right text-xs text-gray-400"><p>修訂版本：2026/01</p></div>
        </div>

        <div class="table-responsive mb-8">
            <table class="w-full pdf-table">
                <tr>
                    <td class="header-bg w-24">派單日期</td>
                    <td colspan="3"><input type="text" id="order-date" class="no-border-input" readonly></td>
                    <td class="header-bg w-24">訂單編號</td>
                    <td colspan="3" class="font-mono font-bold text-blue-800" id="order-id">產生中...</td>
                </tr>
                <tr>
                    <td class="header-bg req">送餐日期</td>
                    <td colspan="3" class="text-center font-bold">
                        <div class="flex flex-col md:flex-row items-center justify-center gap-2">
                            <input type="date" id="delivery-date" class="no-border-input text-center font-bold w-full md:w-auto" required>
                            <span class="hidden md:inline text-gray-300">|</span>
                            <input type="time" id="delivery-time" class="no-border-input text-center font-bold w-full md:w-auto" value="12:00" required>
                        </div>
                    </td>
                    <td colspan="4" class="text-alert">
                        ● 預訂限制：需於出餐前 5 個工作天預訂（系統不開放 7 日內訂單）<br>
                        ● 早晨加成：若餐盒開餐時間於 9:00 以前，將另收取費用 3,500 元<br>
                        ● 撤場規定：若撤場時間晚於 18:00，則另議隔日撤場或加價延遲撤場
                    </td>
                </tr>
                <tr>
                    <td class="header-bg req">聯絡人</td><td colspan="3"><input type="text" id="contact-name" class="no-border-input" placeholder="姓名" required></td>
                    <td class="header-bg w-20 req">公司名稱</td><td colspan="3"><input type="text" id="company-name" class="no-border-input" placeholder="抬頭" required></td>
                </tr>
                <tr>
                    <td class="header-bg">活動模式</td>
                    <td class="font-bold px-2" colspan="3">派對餐盒<input type="hidden" id="activity-mode" value="派對餐盒"></td>
                    <td class="header-bg w-20 req">公司統編</td><td colspan="3"><input type="text" id="tax-id" class="no-border-input" placeholder="8碼數字" required maxlength="8"></td>
                </tr>
                <tr>
                    <td class="header-bg req">用餐人數</td><td class="text-center" colspan="3"><input type="number" id="guest-count" class="no-border-input text-center font-bold" value="100" oninput="calculateTotal()" required min="1"> 人</td>
                    <td class="header-bg w-20 req">手機號碼</td><td colspan="3"><input type="text" id="phone-number" class="no-border-input" placeholder="09XX-XXX-XXX" required></td>
                </tr>
                <tr>
                    <td class="header-bg req">送餐地址</td><td colspan="5"><input type="text" id="delivery-address" placeholder="路名/門牌" class="no-border-input" required></td>
                    <td class="header-bg w-20 req">樓層</td><td><input type="text" id="floor" class="no-border-input text-center" placeholder="F" required></td>
                </tr>
                <tr>
                    <td class="header-bg">場地需求備註</td>
                    <td colspan="7" class="bg-white">
                        <input type="text" id="venue-remarks" placeholder="請填寫場地特殊要求" class="no-border-input">
                        <div class="mt-1 px-2 py-1 bg-blue-50 border-l-4 border-blue-400">
                            <p class="text-xs text-blue-800 leading-relaxed"><span class="font-bold">建議：</span>現場需有基本的水電供應（以符合衛生安全）</p>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="header-bg req">地下停車場</td>
                    <td colspan="7">
                        <div class="flex items-center gap-6 px-2 py-1" id="parking-container">
                            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="parking" value="yes"> 有</label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="parking" value="no"> 無</label>
                            <span class="text-xs text-gray-400 font-normal">(供物流判斷)</span>
                        </div>
                    </td>
                </tr>
            </table>
        </div>

        <h3 class="text-center font-bold mb-3 tracking-widest border-b border-black pb-1 uppercase">訂購餐點明細</h3>
        <div class="table-responsive mb-8">
            <table class="w-full pdf-table">
                <thead>
                    <tr class="header-bg text-center text-xs">
                        <th class="w-16 no-print">示意圖</th>
                        <th>中文餐點名稱</th>
                        <th class="w-32">規格選擇</th>
                        <th class="w-16">盒數</th>
                        <th class="w-24">單價/盒</th>
                        <th class="w-24">小計</th>
                        <th class="w-32">備註</th>
                    </tr>
                </thead>
                <tbody id="menu-appetizer"><tr><td colspan="7" class="category-header">● 小食系列 (Appetizers)</td></tr></tbody>
                <tbody id="menu-dessert"><tr><td colspan="7" class="category-header">● 精緻甜點 (Desserts)</td></tr></tbody>
                <tbody id="menu-beverage"><tr><td colspan="7" class="category-header">● 飲品 (Beverages)</td></tr></tbody>
            </table>
        </div>

        <h3 class="text-center font-bold mb-3 tracking-widest border-b border-black pb-1 uppercase">服務明細</h3>
        <div class="table-responsive mb-8">
            <table class="w-full pdf-table">
                <thead><tr class="header-bg text-center text-xs"><th>服務名稱</th><th>規格說明</th><th>小計</th><th>備註</th></tr></thead>
                <tbody>
                    <tr><td class="text-center">人造花租賃陳列</td><td><select id="prop-rental" class="no-border-input font-bold" onchange="calculateTotal()"><option value="no">無租賃需求</option><option value="yes">租賃道具 (需回收/運費$1,500)</option></select></td><td class="text-center">免費商借</td><td class="text-xs">一日內歸還</td></tr>
                    <tr><td class="text-center font-medium">交通費</td><td id="transport-desc">自動判定</td><td class="text-right font-bold" id="val-transport">$500</td><td class="text-xs text-blue-600 font-medium" id="transport-logic">金額未滿2萬且無回收</td></tr>
                    <tr>
                        <td class="text-center font-medium text-orange-700">人工爬梯搬運</td>
                        <td>
                            <div class="flex items-center gap-2">
                                <select id="stair-count" class="no-border-input font-bold w-20 text-orange-700" onchange="calculateTotal()">
                                    <option value="0">無需求</option><option value="1">1 層</option><option value="2">2 層</option><option value="3">3 層</option><option value="4">4 層</option>
                                </select>
                                <span class="text-[10px] text-gray-400 font-normal">(每層 $3,500)</span>
                            </div>
                        </td>
                        <td class="text-right font-bold text-orange-600" id="val-stair">$0</td>
                        <td class="text-xs text-center">按層數計</td>
                    </tr>
                    <tr><td class="text-center font-medium">餐具提供</td><td class="flex justify-between items-center italic text-gray-500 px-4"><span>免費一次性餐具</span><span id="utensil-info">100 組</span></td><td class="text-center text-gray-400">贈送</td><td class="text-xs text-center">依人數</td></tr>
                </tbody>
            </table>
        </div>

        <div class="flex flex-col md:flex-row justify-between gap-8 mt-10">
            <div class="flex-1 text-xs border p-4 border-black bg-gray-50 leading-relaxed">
                <p class="font-bold underline text-sm mb-3 uppercase tracking-wider">訂購須知</p>
                <div class="space-y-2">
                    <p class="text-red-700 font-bold">1. 預訂期限：需於出餐前 5 個工作天預訂。</p>
                    <p>2. 定金支付：需於餐會前兩週支付七成定金。</p>
                    <p class="text-orange-700 font-medium">3. 爬梯需求：現場若有人工搬運需求，每層酌收 3,500 元。</p>
                    <p class="text-amber-700 font-bold">4. 品質建議：建議勿於室溫下放置超過 2 小時，夏天勿超過 1 小時。</p>
                </div>
            </div>
            <div class="w-full md:w-96">
                <table class="w-full pdf-table">
                    <tr><td class="header-bg w-32">餐點小計</td><td class="text-right font-bold" id="food-total">$0</td></tr>
                    <tr><td class="header-bg">服務小計</td><td class="text-right font-bold" id="service-total">$500</td></tr>
                    <tr><td class="header-bg">營業稅 (5%)</td><td class="text-right font-bold" id="tax-total">$0</td></tr>
                    <tr class="text-xl bg-yellow-50"><td class="header-bg text-red-700">總計</td><td class="text-right font-bold text-red-600" id="grand-total">$0</td></tr>
                    <tr class="text-sm"><td>應付定金 (70%)</td><td class="text-right font-bold text-gray-700" id="deposit-total">$0</td></tr>
                </table>
            </div>
        </div>

        <div class="mt-12 flex flex-col items-center gap-4 no-print">
            <button id="final-action-btn" onclick="processQuotation()" class="bg-black text-white px-14 py-4 rounded-full font-bold hover:bg-gray-800 transition shadow-2xl flex items-center gap-4 text-lg">
                <span id="btn-text">確認資訊並下載報價單</span>
                <span id="btn-spinner" class="hidden spinner"></span>
            </button>
            <p class="text-xs text-gray-400">※ 點擊後系統將執行驗證並自動下載優化後的 PDF 報價單</p>
        </div>
    </div>

    <script>
        // --- 完整餐點清單還原 (S01-B02) ---
        const products = [
            { id: 'S01', cat: 'appetizer', name: '照燒風味迷你漢堡(牛肉)', tags: ['牛肉'], img: '1.照燒風味迷你漢堡(豬肉) (正常).jpg', specs: [{ label: '中盒 (15入)', price: 1350 }, { label: '小盒 (850)', price: 850 }] },
            { id: 'S02', cat: 'appetizer', name: '照燒風味迷你漢堡(雞肉)', tags: ['雞肉'], img: '2.迷你照燒雞腿漢堡（正常）.jpg', specs: [{ label: '中盒 (15入)', price: 1275 }] },
            { id: 'S03', cat: 'appetizer', name: '鹽麴雞肉墨西哥捲餅', tags: ['雞肉'], img: '18.鹽麴雞肉墨西哥捲餅.jpg', specs: [{ label: '中盒 (22入)', price: 1650 }] },
            { id: 'S04', cat: 'appetizer', name: '迷你花生時蔬三明治', tags: ['蛋奶素'], img: '迷你花生時蔬三明治(蛋奶素)_工作區域 1.jpg', specs: [{ label: '中盒 (14入)', price: 560 }] },
            { id: 'S05', cat: 'appetizer', name: '迷你燻雞時蔬三明治', tags: ['雞肉'], img: '5.迷你燻雞吐司三明治.jpg', specs: [{ label: '中盒 (14入)', price: 560 }] },
            { id: 'S06', cat: 'appetizer', name: '迷你火腿起司三明治', tags: [], img: '4.迷你火腿起司吐司三明治.jpg', specs: [{ label: '中盒 (14入)', price: 560 }] },
            { id: 'S07', cat: 'appetizer', name: '復刻版迷你營養三明治', tags: [], img: '3.復刻版迷你營養三明治.jpg', specs: [{ label: '中盒 (12入)', price: 720 }] },
            { id: 'S08', cat: 'appetizer', name: '復刻版迷你營養三明治(素)', tags: ['蛋奶素'], img: '3.復刻版迷你營養三明治.jpg', specs: [{ label: '中盒 (12入)', price: 720 }] },
            { id: 'S09', cat: 'appetizer', name: '綜合花壽司', tags: [], img: '10.綜合花壽司.jpg', specs: [{ label: '中盒 (48入)', price: 960 }] },
            { id: 'S10', cat: 'appetizer', name: '綜合花壽司(全素)', tags: ['全素'], img: '10.綜合花壽司.jpg', specs: [{ label: '中盒 (48入)', price: 960 }] },
            { id: 'S11', cat: 'appetizer', name: '豆皮壽司(素)', tags: ['全素'], img: '11.豆皮壽司(素).jpg', specs: [{ label: '中盒 (40入)', price: 800 }] },
            { id: 'S12', cat: 'appetizer', name: '日式壽司細捲', tags: [], img: '日式壽司細捲_工作區域 1.jpg', specs: [{ label: '中盒 (96入)', price: 1440 }] },
            { id: 'S13', cat: 'appetizer', name: '日式壽司細捲(全素)', tags: ['全素'], img: '日式壽司細捲_工作區域 1.jpg', specs: [{ label: '中盒 (96入)', price: 1440 }] },
            { id: 'S14', cat: 'appetizer', name: '法式起司瑪德蓮', tags: [], img: 'https://images.unsplash.com/photo-1582110271731-972173516597?w=200', specs: [{ label: '中盒 (40入)', price: 1800 }] },
            { id: 'S15', cat: 'appetizer', name: '生態野菜鹹派', tags: ['蛋奶素'], img: '13.生態野菜白醬鹹派.jpg', specs: [{ label: '中盒 (24入)', price: 1440 }] },
            { id: 'S16', cat: 'appetizer', name: '法式千層波菜蚌', tags: [], img: 'https://images.unsplash.com/photo-1541014741259-df549dc46175?w=200', specs: [{ label: '中盒 (24入)', price: 1200 }] },
            { id: 'S17', cat: 'appetizer', name: '迷你番茄披薩卷', tags: [], img: '迷你番茄披薩卷.png', specs: [{ label: '中盒 (24入)', price: 1200 }] },
            { id: 'S18', cat: 'appetizer', name: '番茄莎莎玉米脆片', tags: ['五辛素'], img: '19.番茄莎莎玉米脆片(五辛素).jpg', specs: [{ label: '中盒', price: 1000 }] },
            { id: 'S19', cat: 'appetizer', name: '美式炸物組合', tags: [], img: '21.美式炸物組合.jpg', specs: [{ label: '中盒', price: 1050 }] },
            { id: 'S20', cat: 'appetizer', name: '檸檬酸辣翅小腿', tags: ['雞肉'], img: '22.檸檬酸辣翅小腿.jpg', specs: [{ label: '中盒', price: 1600 }] },
            { id: 'D01', cat: 'dessert', name: '冰心葡式蛋塔', tags: [], img: '冰心葡式蛋塔.png', specs: [{ label: '中盒 (24入)', price: 1200 }] },
            { id: 'D02', cat: 'dessert', name: '迷你棉花糖檸檬塔', tags: ['蛋奶素'], img: '25.迷你棉花糖酸甜檸檬塔（蛋奶素）.jpg', specs: [{ label: '中盒 (24入)', price: 1440 }] },
            { id: 'D03', cat: 'dessert', name: '小倉月燒(紅豆)', tags: ['蛋奶素'], img: '26.小倉月燒.jpg', specs: [{ label: '中盒 (24入)', price: 720 }] },
            { id: 'D04', cat: 'dessert', name: '覆盆子巧克力杯子蛋糕', tags: ['蛋奶素'], img: '28.覆盆子杯子蛋糕.jpg', specs: [{ label: '中盒 (35入)', price: 2275 }] },
            { id: 'D05', cat: 'dessert', name: '抹茶巧克力杯子蛋糕', tags: ['蛋奶素'], img: '27.抹茶杯子蛋糕.jpg', specs: [{ label: '中盒 (35入)', price: 2275 }] },
            { id: 'D06', cat: 'dessert', name: '迷你烏龍茶蛋糕捲', tags: ['蛋奶素'], img: '29.烏龍茶生凍蛋糕捲.jpg', specs: [{ label: '中盒 (30入)', price: 1500 }] },
            { id: 'D07', cat: 'dessert', name: '迷你小甜球', tags: [], img: '迷你小甜球(覆盆子)_工作區域 1.jpg', specs: [{ label: '中盒 (40入)', price: 1200 }] },
            { id: 'D08', cat: 'dessert', name: '放牧雞蛋肉桂布丁麵包', tags: [], img: '31.放牧雞蛋肉桂布丁麵包.jpg', specs: [{ label: '中盒 (28入)', price: 1400 }] },
            { id: 'D09', cat: 'dessert', name: '烏龍茶瑪德蓮', tags: ['蛋奶素'], img: '32.烏龍茶瑪德蓮（大）.jpg', specs: [{ label: '中盒 (32入)', price: 2400 }] },
            { id: 'D10', cat: 'dessert', name: '台東洛神花瑪德蓮', tags: ['蛋奶素'], img: '33.洛神花瑪德蓮（大）.jpg', specs: [{ label: '中盒 (32入)', price: 2400 }] },
            { id: 'D11', cat: 'dessert', name: '焦糖海鹽磅蛋糕', tags: ['蛋奶素'], img: '37.焦糖海鹽磅蛋糕 (蛋奶素).jpg', specs: [{ label: '中盒 (49入)', price: 2450 }] },
            { id: 'D12', cat: 'dessert', name: '椰絲鳳梨磅蛋糕', tags: ['蛋奶素'], img: '39.椰絲鳳梨磅蛋糕(蛋奶素).jpg', specs: [{ label: '中盒 (49入)', price: 2450 }] },
            { id: 'D13', cat: 'dessert', name: '繽紛馬卡龍', tags: ['蛋奶素'], img: '41.繽紛馬卡龍.jpg', specs: [{ label: '中盒 (28入)', price: 840 }] },
            { id: 'D14', cat: 'dessert', name: '茶拉米蘇', tags: ['蛋奶素'], img: '45.茶拉米蘇 (蛋奶素).jpg', specs: [{ label: '中盒 (24入)', price: 2040 }] },
            { id: 'D15', cat: 'dessert', name: '日式抹茶蕨餅', tags: ['蛋奶素'], img: '43.抹茶蕨餅杯 (全素).jpg', specs: [{ label: '中盒 (24入)', price: 1680 }] },
            { id: 'D16', cat: 'dessert', name: '黑糖桂花釀粉粿', tags: ['全素'], img: '44.黑糖桂花釀梔子粉粿 (全素).jpg', specs: [{ label: '中盒 (24入)', price: 1920 }] },
            { id: 'B01', cat: 'beverage', name: '有機蜜香紅茶(冰桶)', tags: ['全素'], img: '飲料桶_工作區域 1.jpg', specs: [{ label: '8公升/桶', price: 1000 }], requiresCollection: true },
            { id: 'B02', cat: 'beverage', name: '公平貿易熱咖啡(桶)', tags: ['全素'], img: '飲料桶_工作區域 1.jpg', specs: [{ label: '8公升/桶', price: 1500 }], requiresCollection: true }
        ];

        let cart = {};

        function generateOrderID() {
            const now = new Date();
            const dateStr = now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0');
            return `Y_${dateStr}-${Date.now().toString().slice(-6)}`;
        }

        function init() {
            const now = new Date();
            document.getElementById('order-date').value = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
            document.getElementById('order-id').innerText = generateOrderID();
            
            const minDate = new Date();
            minDate.setDate(now.getDate() + 7);
            document.getElementById('delivery-date').min = minDate.toISOString().split("T")[0];

            products.forEach(p => {
                const body = document.getElementById(`menu-${p.cat}`);
                if(!body) return;
                const tr = document.createElement('tr');
                tr.id = `row-${p.id}`;
                let tagsHtml = p.tags.map(tag => {
                    let className = 'badge-gray';
                    if (['蛋奶素', '全素', '五辛素'].includes(tag)) className = 'badge-vege';
                    if (['牛肉', '雞肉'].includes(tag)) className = 'badge-meat';
                    return `<span class="badge ${className}">${tag}</span>`;
                }).join(' ');
                
                tr.innerHTML = `
                    <td class="text-center no-print"><img src="${p.img}" class="img-preview" onclick="openLightbox('${p.img}')"></td>
                    <td class="font-bold">${p.name}</td>
                    <td><select class="no-border-input bg-gray-50 text-xs rounded" onchange="updateRow('${p.id}', this.value)">${p.specs.map((s, idx) => `<option value="${idx}">${s.label}</option>`).join('')}</select></td>
                    <td class="text-center"><input type="number" value="0" min="0" oninput="updateQty('${p.id}', this.value)"></td>
                    <td class="text-right font-medium" id="price-${p.id}">$${p.specs[0].price.toLocaleString()}</td>
                    <td class="text-right font-bold text-blue-800" id="sub-${p.id}">$0</td>
                    <td class="text-xs"><div>${tagsHtml}</div><div class="text-gray-400 mt-1">內含包材</div></td>
                `;
                body.appendChild(tr);
            });
            calculateTotal();
        }

        function updateRow(id, specIdx) {
            const p = products.find(i => i.id === id);
            document.getElementById(`price-${id}`).innerText = `$${p.specs[specIdx].price.toLocaleString()}`;
            if (cart[id]) updateQty(id, cart[id].qty);
        }

        function updateQty(id, qty) {
            qty = Math.max(0, parseInt(qty) || 0);
            const p = products.find(i => i.id === id);
            const selectEl = document.querySelector(`#row-${id} select`);
            const specIdx = selectEl ? selectEl.value : 0;
            const price = p.specs[specIdx].price;
            const sub = qty * price;
            document.getElementById(`sub-${id}`).innerText = `$${sub.toLocaleString()}`;
            if (qty > 0) cart[id] = { name: p.name, spec: p.specs[specIdx].label, qty, price, sub, requiresCollection: p.requiresCollection || false };
            else delete cart[id];
            calculateTotal();
        }

        function calculateTotal() {
            let foodSub = Object.values(cart).reduce((a, b) => a + b.sub, 0);
            
            // --- 還原原始交通費判定邏輯 ---
            const hasBucket = Object.values(cart).some(item => item.requiresCollection);
            const hasRentalProps = document.getElementById('prop-rental').value === 'yes';
            const isRoundTrip = foodSub >= 20000 || hasBucket || hasRentalProps;
            const transportFee = isRoundTrip ? 1500 : 500;
            
            document.getElementById('transport-logic').innerText = isRoundTrip ? "滿2萬/桶裝/道具(需回收)" : "金額未滿2萬且無回收";
            document.getElementById('val-transport').innerText = `$${transportFee.toLocaleString()}`;
            
            let stairCount = parseInt(document.getElementById('stair-count').value) || 0;
            let stairFee = stairCount * 3500;
            let serviceSub = transportFee + stairFee;
            
            document.getElementById('food-total').innerText = `$${foodSub.toLocaleString()}`;
            document.getElementById('val-stair').innerText = `$${stairFee.toLocaleString()}`;
            document.getElementById('service-total').innerText = `$${serviceSub.toLocaleString()}`;
            document.getElementById('utensil-info').innerText = `${document.getElementById('guest-count').value} 組`;
            
            let tax = Math.round((foodSub + serviceSub) * 0.05);
            let grand = foodSub + serviceSub + tax;
            
            document.getElementById('tax-total').innerText = `$${tax.toLocaleString()}`;
            document.getElementById('grand-total').innerText = `$${grand.toLocaleString()}`;
            document.getElementById('deposit-total').innerText = `$${Math.round(grand * 0.7).toLocaleString()}`;
        }

        function openLightbox(url) {
            document.getElementById('lightbox-img').src = url;
            document.getElementById('lightbox').style.display = 'flex';
        }

        // --- 核心入口：整合驗證與下載 ---
        async function processQuotation() {
            const btn = document.getElementById('final-action-btn');
            const btnText = document.getElementById('btn-text');
            const spinner = document.getElementById('btn-spinner');

            // 1. 驗證
            if (!validateForm()) return;

            // 2. 鎖定按鈕與顯示載入
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-not-allowed');
            btnText.innerText = "正在生成 PDF...";
            spinner.classList.remove('hidden');

            try {
                // 3. 執行 PDF 下載 (深度優化參數)
                await downloadPDF();

                btnText.innerText = "報價單下載成功！";
                spinner.classList.add('hidden');
                btn.classList.replace('bg-black', 'bg-green-600');
                alert("下單驗證成功！優化後的 PDF 報價單已開始下載。");
            } catch (error) {
                console.error(error);
                alert("下載失敗，請稍後再試。");
                btn.disabled = false;
                spinner.classList.add('hidden');
                btnText.innerText = "確認資訊並下載報價單";
            }
        }

        function validateForm() {
            const required = ['delivery-date', 'contact-name', 'company-name', 'tax-id', 'phone-number', 'delivery-address', 'floor'];
            let errors = [];
            required.forEach(id => {
                const el = document.getElementById(id);
                el.classList.remove('input-error');
                if (!el.value || el.value.trim() === "") { errors.push(id); el.classList.add('input-error'); }
            });
            if (!document.querySelector('input[name="parking"]:checked')) errors.push('停車資訊');
            if (Object.keys(cart).length === 0) errors.push('餐點明細');
            
            if (errors.length > 0) { alert("請填寫所有必填欄位並選購餐點。"); return false; }
            return true;
        }

        async function downloadPDF() {
            const element = document.getElementById('quotation-content');
            const orderId = document.getElementById('order-id').innerText;
            const opt = {
                margin: 10,
                filename: `木人艸報價單_${orderId}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, 
                    windowWidth: 1100 // 強制模擬寬度，確保表格比例 1:1 還原網頁
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css'] }
            };
            return html2pdf().set(opt).from(element).save();
        }

        init();
    </script>
</body>
</html>
