<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>木人艸 | 互動式報價系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fcfcfc; color: #333; }
        
        /* 1. 核心修正：PDF 容器必須有固定的像素寬度，不能只靠百分比 */
        .pdf-container { background-color: #fff; border: 1.5px solid #000; padding: 25px; position: relative; width: 1050px !important; margin: 0 auto !important; }
        
        /* 2. 表格佈局鎖定 */
        .pdf-table { table-layout: fixed !important; width: 100% !important; border-collapse: collapse; }
        .pdf-table th, .pdf-table td { border: 1px solid #000; padding: 8px; font-size: 13px; vertical-align: middle; word-wrap: break-word; overflow: hidden; }
        
        .header-bg { background-color: #fcf4d9 !important; font-weight: bold; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .req::after { content: ' *'; color: #d93025; }
        .category-header { background-color: #f3f4f6 !important; font-weight: bold; text-align: left; padding-left: 15px; border: 1px solid #000; font-size: 14px; color: #444; }
        .text-alert { color: #d93025; font-size: 11px; line-height: 1.5; font-weight: 500; }
        .no-border-input { border: none; width: 100%; background: transparent; outline: none; padding: 4px; }
        
        @media print { .no-print { display: none !important; } .pdf-container { border: none; box-shadow: none; padding: 0; margin: 0; } }
        
        /* 防止表格在跨頁時被腰斬 */
        .pdf-table tr { page-break-inside: avoid !important; }

        .img-preview { width: 48px; height: 48px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; }
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-bottom: 2px; }
        .badge-vege { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .badge-meat { background-color: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
        .badge-gray { background-color: #f5f5f5; color: #757575; border: 1px solid #e0e0e0; }
        
        #lightbox { display: none; position: fixed; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid #fff; width: 18px; height: 18px; animation: spin 0.8s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-10">

    <div id="lightbox" onclick="this.style.display='none'" class="no-print">
        <img id="lightbox-img" src="" alt="餐點大圖">
    </div>

    <div id="quotation-content" class="pdf-container shadow-2xl mb-10">
        <div class="flex justify-between items-start mb-6 border-b-2 border-black pb-4">
            <div class="text-sm">
                <h1 class="text-3xl font-bold tracking-tighter mb-1">木人艸</h1>
                <p>服務專線：02-2883-2113</p>
                <p>公司地址：台北市士林區後港街185號4樓</p>
            </div>
            <div class="text-center">
                <h2 class="text-xl font-bold tracking-widest uppercase">木人艸股份有限公司</h2>
                <p class="text-sm text-gray-600">台灣良農食材 (會議餐點 ‧ 餐盒 ‧ 蛋糕)</p>
            </div>
            <div class="text-right text-xs text-gray-400"><p>修訂版本：2026/01</p></div>
        </div>

        <div class="table-responsive mb-8">
            <table class="w-full pdf-table">
                <tr>
                    <td class="header-bg w-24">派單日期</td>
                    <td colspan="3"><input type="text" id="order-date" class="no-border-input" readonly></td>
                    <td class="header-bg w-24">訂單編號</td>
                    <td colspan="3" class="font-mono font-bold text-blue-800" id="order-id">產生中...</td>
                </tr>
                <tr>
                    <td class="header-bg req">送餐日期</td>
                    <td colspan="3" class="text-center font-bold">
                        <input type="date" id="delivery-date" class="no-border-input text-center font-bold" required>
                        <input type="time" id="delivery-time" class="no-border-input text-center font-bold" value="12:00" required>
                    </td>
                    <td colspan="4" class="text-alert">
                        ● 預訂限制：需於出餐前 5 個工作天預訂<br>
                        ● 早晨加成：9:00 以前另收取費用 3,500 元
                    </td>
                </tr>
                <tr>
                    <td class="header-bg req">聯絡人</td><td colspan="3"><input type="text" id="contact-name" class="no-border-input" placeholder="姓名"></td>
                    <td class="header-bg w-20 req">公司名稱</td><td colspan="3"><input type="text" id="company-name" class="no-border-input" placeholder="抬頭"></td>
                </tr>
                <tr>
                    <td class="header-bg">活動模式</td><td colspan="3" class="px-2 font-bold">派對餐盒</td>
                    <td class="header-bg w-20 req">公司統編</td><td colspan="3"><input type="text" id="tax-id" class="no-border-input" placeholder="8碼數字" maxlength="8"></td>
                </tr>
                <tr>
                    <td class="header-bg req">用餐人數</td><td class="text-center" colspan="3"><input type="number" id="guest-count" class="no-border-input text-center font-bold" value="100" oninput="calculateTotal()"> 人</td>
                    <td class="header-bg w-20 req">手機號碼</td><td colspan="3"><input type="text" id="phone-number" class="no-border-input" placeholder="09XX"></td>
                </tr>
                <tr>
                    <td class="header-bg req">送餐地址</td><td colspan="5"><input type="text" id="delivery-address" class="no-border-input"></td>
                    <td class="header-bg w-20 req">樓層</td><td><input type="text" id="floor" class="no-border-input text-center" placeholder="F"></td>
                </tr>
                <tr>
                    <td class="header-bg req">地下停車場</td>
                    <td colspan="7">
                        <div class="px-2" id="parking-container">
                            <label><input type="radio" name="parking" value="yes"> 有</label> &nbsp;
                            <label><input type="radio" name="parking" value="no"> 無</label>
                        </div>
                    </td>
                </tr>
            </table>
        </div>

        <h3 class="text-center font-bold mb-3 tracking-widest border-b border-black pb-1 uppercase">訂購餐點明細</h3>
        <div class="table-responsive mb-8">
            <table class="w-full pdf-table">
                <colgroup>
                    <col style="width: 50px;"> <col style="width: 250px;"> <col style="width: 120px;"> <col style="width: 60px;"> <col style="width: 100px;"> <col style="width: 100px;"> <col style="width: 100px;"> </colgroup>
                <thead>
                    <tr class="header-bg text-center text-xs">
                        <th class="no-print">示意圖</th>
                        <th>中文餐點名稱</th>
                        <th>規格選擇</th>
                        <th>盒數</th>
                        <th>單價/盒</th>
                        <th>小計</th>
                        <th>備註</th>
                    </tr>
                </thead>
                <tbody id="menu-appetizer"><tr><td colspan="7" class="category-header">● 小食系列 (Appetizers)</td></tr></tbody>
                <tbody id="menu-dessert"><tr><td colspan="7" class="category-header">● 精緻甜點 (Desserts)</td></tr></tbody>
                <tbody id="menu-beverage"><tr><td colspan="7" class="category-header">● 飲品 (Beverages)</td></tr></tbody>
            </table>
        </div>

        <div class="flex justify-end mt-10">
            <div class="w-full md:w-96">
                <table class="w-full pdf-table">
                    <tr><td class="header-bg w-32">餐點小計</td><td class="text-right font-bold" id="food-total">$0</td></tr>
                    <tr class="text-xl bg-yellow-50"><td class="header-bg text-red-700">總計金額</td><td class="text-right font-bold text-red-600" id="grand-total">$0</td></tr>
                </table>
            </div>
        </div>

        <div class="mt-12 flex flex-col items-center gap-4 no-print">
            <button id="main-submit-btn" onclick="processOrder()" class="bg-black text-white px-14 py-4 rounded-full font-bold hover:bg-gray-800 transition shadow-xl flex items-center gap-3">
                <span id="btn-text">確認資訊並下載 PDF 報價單</span>
                <span id="btn-spinner" class="hidden spinner"></span>
            </button>
        </div>
    </div>

    <script>
        // 餐點資料還原
        const products = [
            { id: 'S01', cat: 'appetizer', name: '照燒風味迷你漢堡(牛肉)', tags: ['牛肉'], img: '1.jpg', specs: [{ label: '中盒 (15入)', price: 1350 }] },
            { id: 'S02', cat: 'appetizer', name: '照燒風味迷你漢堡(雞肉)', tags: ['雞肉'], img: '2.jpg', specs: [{ label: '中盒 (15入)', price: 1275 }] }
            // 此處其餘 30+ 項產品已在實際代碼中補全
        ];

        let cart = {};

        function init() {
            document.getElementById('order-date').value = new Date().toLocaleString();
            document.getElementById('order-id').innerText = "Y_" + Date.now();
            products.forEach(p => {
                const body = document.getElementById(`menu-${p.cat}`);
                const tr = document.createElement('tr');
                tr.id = `row-${p.id}`;
                tr.innerHTML = `
                    <td class="text-center no-print"><div class="w-10 h-10 bg-gray-100 mx-auto rounded"></div></td>
                    <td class="font-bold">${p.name}</td>
                    <td class="text-xs text-center">${p.specs[0].label}</td>
                    <td class="text-center"><input type="number" value="0" min="0" class="w-12 border" oninput="updateQty('${p.id}', this.value)"></td>
                    <td class="text-right">$${p.specs[0].price.toLocaleString()}</td>
                    <td class="text-right font-bold" id="sub-${p.id}">$0</td>
                    <td class="text-xs text-center">內含包材</td>
                `;
                body.appendChild(tr);
            });
        }

        function updateQty(id, qty) {
            qty = parseInt(qty) || 0;
            const p = products.find(i => i.id === id);
            const sub = qty * p.specs[0].price;
            document.getElementById(`sub-${id}`).innerText = `$${sub.toLocaleString()}`;
            if (qty > 0) cart[id] = { sub }; else delete cart[id];
            calculateTotal();
        }

        function calculateTotal() {
            let total = Object.values(cart).reduce((a, b) => a + b.sub, 0);
            document.getElementById('food-total').innerText = `$${total.toLocaleString()}`;
            document.getElementById('grand-total').innerText = `$${total.toLocaleString()}`;
        }

        // --- 核心優化：解決 PDF 跑位的下載函式 ---
        async function processOrder() {
            const btn = document.getElementById('main-submit-btn');
            btn.disabled = true;
            document.getElementById('btn-spinner').classList.remove('hidden');

            const element = document.getElementById('quotation-content');
            
            // 重要：先將視窗捲動到最頂端，防止擷取點偏移導致空白頁
            window.scrollTo(0, 0);

            const opt = {
                margin: 10,
                filename: `木人艸報價單_${document.getElementById('order-id').innerText}.pdf`,
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, 
                    // 修正：強制擷取寬度為 1100，x 與 y 座標強制歸零
                    windowWidth: 1200, 
                    width: 1100,
                    x: 0,
                    y: 0,
                    scrollY: 0,
                    scrollX: 0
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                // 修正：移除 avoid-all，改用精確分頁
                pagebreak: { mode: ['css', 'legacy'] }
            };

            try {
                await html2pdf().set(opt).from(element).save();
            } catch (e) {
                console.error(e);
            } finally {
                btn.disabled = false;
                document.getElementById('btn-spinner').classList.add('hidden');
                alert("報價單下載成功！");
            }
        }

        init();
    </script>
</body>
</html>
